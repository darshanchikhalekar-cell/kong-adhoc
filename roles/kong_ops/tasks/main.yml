---
# =========================
# NORMALIZE INPUTS
# =========================
- name: Normalize inputs
  set_fact:
    adhoc_cmd_final: "{{ adhoc_cmd | default('whoami') }}"
    kong_action_final: "{{ kong_action | default('none') }}"

# =========================
# VALIDATE kong_action (only if not none)
# =========================
- name: Validate kong_action
  fail:
    msg: "Invalid kong_action: {{ kong_action_final }}"
  when:
    - kong_action_final != 'none'
    - kong_action_final not in [
        'kong_start',
        'kong_stop',
        'kong_restart',
        'fetch_access_logs',
        'fetch_error_logs'
      ]

# =========================
# RUN ADHOC COMMAND (ONLY WHEN NO ACTION)
# =========================
- name: Run adhoc command
  shell: "{{ adhoc_cmd_final }}"
  register: adhoc_result
  changed_when: false
  when: kong_action_final == 'none'

# =========================
# LOG ACTIONS
# =========================
- name: Include log tasks
  include_tasks: logs.yml
  when: kong_action_final in ['fetch_access_logs', 'fetch_error_logs']

# ======
