---
- name: Kong Ops â€“ Adhoc Operations
  hosts: all
  gather_facts: false

  vars:
    kong_bin: /usr/local/bin/kong
    kong_error_log: /usr/local/kong/logs/error.log
    kong_access_log: /usr/local/kong/logs/access.log

  tasks:

    # =========================
    # NORMALIZE SURVEY INPUT
    # =========================
    - name: Normalize survey input
      set_fact:
        kong_action_final: "{{ kong_action | default('whoami') }}"

    # =========================
    # WHOAMI
    # =========================
    - name: Who am I
      raw: whoami
      register: whoami_out
      changed_when: false
      when: kong_action_final == 'whoami'

    - debug:
        msg: "Executed as user: {{ whoami_out.stdout }}"
      when: kong_action_final == 'whoami'

    # =========================
    # KONG HEALTH
    # =========================
    - name: Kong health
      raw: "{{ kong_bin }} health"
      register: kong_health
      changed_when: false
      when: kong_action_final == 'health'

    - debug:
        msg: "{{ kong_health.stdout }}"
      when: kong_action_final == 'health'

    # =========================
    # KONG STATUS
    # =========================
    - name: Kong status
      raw: "{{ kong_bin }} status"
      register: kong_status
      changed_when: false
      when: kong_action_final == 'status'

    - debug:
        msg: "{{ kong_status.stdout }}"
      when: kong_action_final == 'status'

    # =========================
    # KONG VERSION
    # =========================
    - name: Kong version
      raw: "{{ kong_bin }} version"
      register: kong_version
      changed_when: false
      when: kong_action_final == 'version'

    - debug:
        msg: "{{ kong_version.stdout }}"
      when: kong_action_final == 'version'

    # =========================
    # ERROR LOGS
    # =========================
    - name: Kong error logs (last 50 lines)
      raw: "tail -n 50 {{ kong_error_log }}"
      register: kong_error_logs
      changed_when: false
      when: kong_action_final == 'error_logs'

    - debug:
        msg: "{{ kong_error_logs.stdout }}"
      when: kong_action_final == 'error_logs'

    # =========================
    # ACCESS LOGS
    # =========================
    - name: Kong access logs (last 50 lines)
      raw: "tail -n 50 {{ kong_access_log }}"
      register: kong_access_logs
      changed_when: false
      when: kong_action_final == 'access_logs'

    - debug:
        msg: "{{ kong_access_logs.stdout }}"
      when: kong_action_final == 'access_logs'

    # =========================
    # KONG START
    # =========================
    - name: Kong start
      raw: "{{ kong_bin }} start"
      when: kong_action_final == 'start'

    # =========================
    # KONG STOP
    # =========================
    - name: Kong stop
      raw: "{{ kong_bin }} stop"
      when: kong_action_final == 'stop'

    # =========================
    # KONG RESTART
    # =========================
    - name: Kong restart
      raw: "{{ kong_bin }} restart"
      when: kong_action_final == 'restart'
