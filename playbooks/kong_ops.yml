- name: Kong Ops â€“ Adhoc Operations
  hosts: all
  gather_facts: false
  become: false   # raw + sudo inside command

  vars:
    kong_cmd: "whoami"   # safe default

  tasks:

    # =========================
    # WHOAMI
    # =========================
    - name: Who am I
      raw: whoami
      register: whoami_out
      changed_when: false
      when: kong_cmd == "whoami"

    - name: Whoami output
      debug:
        msg: "Executed as user: {{ whoami_out.stdout | trim }}"
      when: kong_cmd == "whoami"


    # =========================
    # KONG VERSION
    # =========================
    - name: Get Kong version
      raw: kong version
      register: kong_version
      changed_when: false
      when: kong_cmd == "version"

    - name: Kong version output
      debug:
        msg: "Kong version: {{ kong_version.stdout | trim }}"
      when: kong_cmd == "version"


    # =========================
    # KONG STATUS (NON-INTERACTIVE)
    # =========================
    - name: Get Kong service status
      raw: systemctl is-active kong
      register: kong_status
      changed_when: false
      when: kong_cmd == "status"

    - name: Kong status output
      debug:
        msg: "Kong service status: {{ kong_status.stdout | trim }}"
      when: kong_cmd == "status"


    # =========================
    # RESTART KONG
    # =========================
    - name: Restart Kong
      raw: sudo systemctl restart kong
      when: kong_cmd == "restart"

    - name: Restart confirmation
      debug:
        msg: "Kong service restarted successfully"
      when: kong_cmd == "restart"


    # =========================
    # SUMMARY
    # =========================
    - name: Set summary stats
      set_stats:
        data:
          action: "{{ kong_cmd }}"
          result: >-
            {% if kong_cmd == 'whoami' %}
            Executed as {{ whoami_out.stdout | trim }}
            {% elif kong_cmd == 'version' %}
            {{ kong_version.stdout | trim }}
            {% elif kong_cmd == 'status' %}
            Kong service is {{ kong_status.stdout | trim }}
            {% elif kong_cmd == 'restart' %}
            Kong restarted
            {% endif %}
