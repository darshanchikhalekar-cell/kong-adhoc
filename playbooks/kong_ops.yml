- name: Kong Ops â€“ Adhoc Operations
  hosts: all
  gather_facts: false

  tasks:

    # =========================
    # NORMALIZE INPUTS
    # =========================
    - name: Normalize inputs
      set_fact:
        kong_cmd_final: "{{ kong_cmd | default('whoami') }}"
        kong_action_final: "{{ kong_action | default('none') }}"

    # =========================
    # CMD (ONLY IF NO ACTION)
    # =========================
    - name: Who am I
      raw: whoami
      register: whoami_out
      changed_when: false
      when:
        - kong_action_final == 'none'
        - kong_cmd_final == "whoami"

    - name: Whoami output
      debug:
        msg: "Executed as user: {{ whoami_out.stdout | trim }}"
      when:
        - kong_action_final == 'none'
        - kong_cmd_final == "whoami"

    # =========================
    # ACTION: START KONG
    # =========================
    - name: Start Kong
      raw: sudo kong start
      register: kong_start_out
      when: kong_action_final == "kong_start"

    - name: Start Kong result
      debug:
        msg: "âœ… Kong started successfully"
      when: kong_action_final == "kong_start"

    # =========================
    # ACTION: STOP KONG
    # =========================
    - name: Stop Kong
      raw: sudo kong stop
      register: kong_stop_out
      when: kong_action_final == "kong_stop"

    - name: Stop Kong result
      debug:
        msg: "ðŸ›‘ Kong stopped successfully"
      when: kong_action_final == "kong_stop"

    # =========================
    # ACTION: RESTART KONG
    # =========================
    - name: Restart Kong
      raw: sudo kong restart
      register: kong_restart_out
      when: kong_action_final == "kong_restart"

    - name: Restart Kong result
      debug:
        msg: "ðŸ” Kong restarted successfully"
      when: kong_action_final == "kong_restart"

    # =========================
    # JOB SUMMARY (STATS TAB)
    # =========================
    - name: Job Summary
  set_stats:
    data:
      cmd_selected: "{{ kong_cmd_final }}"
      action_selected: "{{ kong_action_final }}"
      execution_mode: "{{ 'ACTION' if kong_action_final != 'none' else 'CMD' }}"
      result: >-
        {% if kong_action_final == 'kong_start' %}
        Kong started successfully
        {% elif kong_action_final == 'kong_stop' %}
        Kong stopped successfully
        {% elif kong_action_final == 'kong_restart' %}
        Kong restarted successfully
        {% elif kong_action_final == 'fetch_access_logs' %}
        Access logs displayed in job output
        {% elif kong_action_final == 'fetch_error_logs' %}
        Error logs displayed in job output
        {% else %}
        Adhoc command executed successfully
        {% endif %}
