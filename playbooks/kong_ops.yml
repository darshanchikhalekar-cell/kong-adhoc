- name: Kong Ops â€“ Adhoc Operations
  hosts: all
  gather_facts: false

  tasks:

    # =========================
    # NORMALIZE INPUTS
    # =========================
    - name: Normalize inputs
      set_fact:
        kong_cmd_final: "{{ kong_cmd | default('whoami') }}"
        kong_action_final: "{{ kong_action | default('none') }}"

    # =========================
    # CMD (ONLY IF NO ACTION)
    # =========================
    - name: Who am I
      raw: whoami
      register: whoami_out
      changed_when: false
      when:
        - kong_action_final == 'none'
        - kong_cmd_final == "whoami"

    - name: Whoami output
      debug:
        msg: "Executed as user: {{ whoami_out.stdout | trim }}"
      when:
        - kong_action_final == 'none'
        - kong_cmd_final == "whoami"

    # =========================
    # ACTION: START KONG
    # =========================
    - name: Start Kong
      raw: sudo kong start
      when: kong_action_final == "kong_start"

    # =========================
    # ACTION: STOP KONG
    # =========================
    - name: Stop Kong
      raw: sudo kong stop
      when: kong_action_final == "kong_stop"

    # =========================
    # ACTION: RESTART KONG
    # =========================
    - name: Restart Kong
      raw: sudo kong restart
      when: kong_action_final == "kong_restart"

    # =========================
    # SUMMARY
    # =========================
    - name: Job Summary
      set_stats:
        data:
          cmd: "{{ kong_cmd_final }}"
          action: "{{ kong_action_final }}"
          execution: "{{ 'ACTION' if kong_action_final != 'none' else 'CMD' }}"
