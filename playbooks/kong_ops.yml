---
- name: Kong Ops â€“ Adhoc Operations
  hosts: all
  gather_facts: false
  become: false   # default: no sudo

  vars:
    kong_bin: /usr/local/bin/kong
    kong_error_log: /usr/local/kong/logs/error.log
    kong_access_log: /usr/local/kong/logs/access.log

  tasks:

    - name: Normalize survey input
      set_fact:
        kong_action_final: "{{ kong_action | default('whoami') }}"

    # READ-ONLY COMMANDS (NO SUDO)

    - name: Who am I
      raw: whoami
      register: whoami_out
      changed_when: false
      when: kong_action_final == 'whoami'

    - debug:
        msg: "Executed as user: {{ whoami_out.stdout }}"
      when: kong_action_final == 'whoami'

    - name: Kong health
      raw: "{{ kong_bin }} health"
      register: kong_health
      changed_when: false
      when: kong_action_final == 'health'

    - debug:
        msg: "{{ kong_health.stdout }}"
      when: kong_action_final == 'health'

    - name: Kong status
      raw: "{{ kong_bin }} status"
      register: kong_status
      changed_when: false
      when: kong_action_final == 'status'

    - debug:
        msg: "{{ kong_status.stdout }}"
      when: kong_action_final == 'status'

    - name: Kong version
      raw: "{{ kong_bin }} version"
      register: kong_version
      changed_when: false
      when: kong_action_final == 'version'

    - debug:
        msg: "{{ kong_version.stdout }}"
      when: kong_action_final == 'version'

    - name: Kong error logs
      raw: "tail -n 50 {{ kong_error_log }}"
      register: kong_error_logs
      changed_when: false
      when: kong_action_final == 'error_logs'

    - debug:
        msg: "{{ kong_error_logs.stdout }}"
      when: kong_action_final == 'error_logs'

    - name: Kong access logs
      raw: "tail -n 50 {{ kong_access_log }}"
      register: kong_access_logs
      changed_when: false
      when: kong_action_final == 'access_logs'

    - debug:
        msg: "{{ kong_access_logs.stdout }}"
      when: kong_action_final == 'access_logs'

    # CONTROL COMMANDS (REQUIRE SUDO)

    - name: Kong start
      raw: "{{ kong_bin }} start"
      become: true
      when: kong_action_final == 'start'

    - name: Kong stop
      raw: "{{ kong_bin }} stop"
      become: true
      when: kong_action_final == 'stop'

    - name: Kong reload
      raw: "{{ kong_bin }} reload"
      become: true
      when: kong_action_final == 'reload'

    - name: Kong restart
      raw: "{{ kong_bin }} restart"
      become: true
      when: kong_action_final == 'restart'
