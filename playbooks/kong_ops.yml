- name: Kong Ops â€“ Adhoc Operations
  hosts: all
  gather_facts: false
  become: false

  tasks:

    # =========================
    # NORMALIZE SURVEY INPUT
    # =========================
    - name: Normalize kong command
      set_fact:
        kong_cmd_final: "{{ kong_cmd | default('whoami') }}"

    # =========================
    # WHOAMI
    # =========================
    - name: Who am I
      raw: whoami
      register: whoami_out
      changed_when: false
      when: kong_cmd_final == "whoami"

    - name: Whoami output
      debug:
        msg: "Executed as user: {{ whoami_out.stdout | trim }}"
      when: kong_cmd_final == "whoami"

    # =========================
    # KONG VERSION
    # =========================
    - name: Get Kong version
      raw: kong version
      register: kong_version
      changed_when: false
      when: kong_cmd_final == "version"

    - name: Kong version output
      debug:
        msg: "Kong version: {{ kong_version.stdout | trim }}"
      when: kong_cmd_final == "version"

    # =========================
    # KONG STATUS (PROCESS / PORT BASED)
    # =========================
    - name: Check Kong process status
      raw: pgrep -f kong || true
      register: kong_status
      changed_when: false
      when: kong_cmd_final == "status"

    - name: Kong status output
      debug:
        msg: >-
          {% if kong_status.stdout | trim == '' %}
          Kong process is NOT running
          {% else %}
          Kong process is RUNNING
          {% endif %}
      when: kong_cmd_final == "status"

    # =========================
    # KONG HEALTH (APPLICATION LEVEL)
    # =========================
    - name: Check Kong health
      raw: kong health || true
      register: kong_health
      changed_when: false
      when: kong_cmd_final == "health"

    - name: Kong health output
      debug:
        msg: >-
          {% if kong_health.stdout | trim == '' %}
          Kong health check FAILED
          {% else %}
          Kong health is OK
          {% endif %}
      when: kong_cmd_final == "health"

    # =========================
    # JOB SUMMARY (STATS TAB)
    # =========================
    - name: Set job summary
      set_stats:
        data:
          action: "{{ kong_cmd_final }}"
          result: >-
            {% if kong_cmd_final == 'whoami' %}
            Executed as {{ whoami_out.stdout | trim }}
            {% elif kong_cmd_final == 'version' %}
            {{ kong_version.stdout | trim }}
            {% elif kong_cmd_final == 'status' %}
            {% if kong_status.stdout | trim == '' %}
            Kong process is NOT running
            {% else %}
            Kong process is RUNNING
            {% endif %}
            {% elif kong_cmd_final == 'health' %}
            {% if kong_health.stdout | trim == '' %}
            Kong health FAILED
            {% else %}
            Kong health OK
            {% endif %}
            {% endif %}
