- name: Kong Ops â€“ Adhoc Operations
  hosts: all
  gather_facts: false

  tasks:

    # =========================
    # NORMALIZE INPUTS
    # =========================
    - name: Normalize inputs
      set_fact:
        kong_cmd_final: "{{ kong_cmd | default('whoami') }}"
        kong_action_final: "{{ kong_action | default('none') }}"

    # =================================================
    # CMD (ONLY IF NO ACTION)
    # =================================================

    # WHOAMI
    - name: Who am I
      raw: whoami
      register: whoami_out
      changed_when: false
      when:
        - kong_action_final == 'none'
        - kong_cmd_final == "whoami"

    - name: Whoami output
      debug:
        msg: "Executed as user: {{ whoami_out.stdout | trim }}"
      when:
        - kong_action_final == 'none'
        - kong_cmd_final == "whoami"

    # VERSION
    - name: Kong version
      raw: kong version
      register: kong_version
      changed_when: false
      when:
        - kong_action_final == 'none'
        - kong_cmd_final == "version"

    - name: Kong version output
      debug:
        msg: "{{ kong_version.stdout | trim }}"
      when:
        - kong_action_final == 'none'
        - kong_cmd_final == "version"

    # STATUS (PROCESS BASED)
    - name: Kong status
      raw: pgrep -f kong || true
      register: kong_status
      changed_when: false
      when:
        - kong_action_final == 'none'
        - kong_cmd_final == "status"

    - name: Kong status output
      debug:
        msg: >-
          {% if kong_status.stdout | trim == '' %}
          Kong process is NOT running
          {% else %}
          Kong process is RUNNING
          {% endif %}
      when:
        - kong_action_final == 'none'
        - kong_cmd_final == "status"

    # HEALTH
    - name: Kong health
      raw: kong health || true
      register: kong_health
      changed_when: false
      when:
        - kong_action_final == 'none'
        - kong_cmd_final == "health"

    - name: Kong health output
      debug:
        msg: >-
          {% if kong_health.stdout | trim == '' %}
          Kong health FAILED
          {% else %}
          Kong health OK
          {% endif %}
      when:
        - kong_action_final == 'none'
        - kong_cmd_final == "health"

    # =================================================
    # ACTIONS
    # =================================================

    - name: Start Kong
      raw: sudo kong start
      when: kong_action_final == "kong_start"

    - name: Start Kong success
      debug:
        msg: "âœ… Kong started successfully"
      when: kong_action_final == "kong_start"

    - name: Stop Kong
      raw: sudo kong stop
      when: kong_action_final == "kong_stop"

    - name: Stop Kong success
      debug:
        msg: "ðŸ›‘ Kong stopped successfully"
      when: kong_action_final == "kong_stop"

    - name: Restart Kong
      raw: sudo kong restart
      when: kong_action_final == "kong_restart"

    - name: Restart Kong success
      debug:
        msg: "ðŸ” Kong restarted successfully"
      when: kong_action_final == "kong_restart"

    # =================================================
    # JOB SUMMARY (INPUT-BASED, SAFE)
    # =================================================
    - name: Job Summary
      set_stats:
        data:
          cmd_selected: "{{ kong_cmd_final }}"
          action_selected: "{{ kong_action_final }}"
          execution_mode: "{{ 'ACTION' if kong_action_final != 'none' else 'CMD' }}"
          result: >-
            {% if kong_action_final == 'kong_start' %}
            Kong started successfully
            {% elif kong_action_final == 'kong_stop' %}
            Kong stopped successfully
            {% elif kong_action_final == 'kong_restart' %}
            Kong restarted successfully
            {% else %}
            Command {{ kong_cmd_final }} executed successfully
            {% endif %}
